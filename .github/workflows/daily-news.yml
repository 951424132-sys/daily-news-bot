name: Daily News Push

on:
  workflow_dispatch:
    inputs:
      topic:
        description: News topic
        required: false
        default: ç§‘æŠ€

jobs:
  fetch-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.9"
      - name: Install dependencies
        run: pip install requests feedparser
      - name: Run news bot
        env:
          TOPIC: ${{ github.event.inputs.topic || 'ç§‘æŠ€' }}
          WECOM_WEBHOOK_URL: ${{ secrets.WECOM_WEBHOOK_URL }}
          WECOM_WEBHOOK_URL1: ${{ secrets.WECOM_WEBHOOK_URL1 }}
          WECOM_WEBHOOK_URL2: ${{ secrets.WECOM_WEBHOOK_URL2 }}
        run: |
          python3 - <<'PY'
          import os, urllib.parse, requests, feedparser
          from datetime import datetime

          TOPIC = os.environ.get('TOPIC', 'ç§‘æŠ€')
          WEBHOOK_URLS = [
              os.environ.get('WECOM_WEBHOOK_URL', ''),
              os.environ.get('WECOM_WEBHOOK_URL1', ''),
              os.environ.get('WECOM_WEBHOOK_URL2', '')
          ]
          WEBHOOK_URLS = [url for url in WEBHOOK_URLS if url]

          print(f"TOPIC: {TOPIC}")
          print(f"Webhooks found: {len(WEBHOOK_URLS)}")

          url = f"https://news.google.com/rss/search?q={urllib.parse.quote(TOPIC)}+when:1d&hl=zh-CN"
          feed = feedparser.parse(url)
          items = []

          for e in feed.entries[:10]:
              t = e.title.split(' - ')[0] if ' - ' in e.title else e.title
              items.append({'title': t, 'link': e.link})

          date = datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')
          msg = f"## â˜€ æ—©å®‰ï¼ä»Šæ—¥èµ„è®¯ç®€æŠ¥\n\n**ðŸ“… æ—¥æœŸ**:{date}\n**ðŸ“Œ ä¸»é¢˜**:{TOPIC}\n\n"

          for i, item in enumerate(items, 1):
              msg += f"**{i}.** [{item['title']}]({item['link']})\n"
          msg += "\n---\nðŸ’¡ *ç¥æ‚¨ä»Šå¤©å·¥ä½œé¡ºåˆ©ï¼*"

          print(f"Items fetched: {len(items)}")

          if WEBHOOK_URLS:
              for i, webhook in enumerate(WEBHOOK_URLS, 1):
                  print(f"Sending to group {i}...")
                  r = requests.post(webhook, json={'msgtype': 'markdown', 'markdown': {'content': msg}}, timeout=10)
                  print(f"Group {i} - Status: {r.status_code}")
                  if r.status_code == 200:
                      print(f"Group {i} - Success!")
                  else:
                      print(f"Group {i} - Failed: {r.text}")
          else:
              print("ERROR: No Webhook URLs configured!")
          PY
